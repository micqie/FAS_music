<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Student Packages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gold: { 400: '#d4af37', 500: '#b8860b', 600: '#996515' },
                        obsidian: '#0a0a0a'
                    }
                }
            }
        }
        if (typeof console !== 'undefined' && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-obsidian text-gray-900 dark:text-zinc-100">
    <!-- Top Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 h-16 bg-black/95 dark:bg-black border-b border-gold-500/20 z-50 flex items-center justify-between px-6 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-lg bg-gold-500/20 border border-gold-500/30 flex items-center justify-center">
                <i class="fas fa-music text-gold-500 text-lg"></i>
            </div>
            <div>
                <p class="text-xs text-zinc-400 uppercase tracking-wider">Father & Sons</p>
                <p class="text-sm font-semibold text-white">Music Academy</p>
            </div>
        </div>
        <div class="flex items-center gap-3" id="userInfoNav">
            <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 transition">
                <i class="fas fa-user-circle text-gold-400 text-xl"></i>
                <div class="text-right">
                    <p class="text-xs text-zinc-400" id="userRoleNav">Admin</p>
                    <p class="text-sm font-medium text-white" id="userNameNav">Loading...</p>
                </div>
                <i class="fas fa-chevron-down text-zinc-400 text-xs ml-2"></i>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-black border-r border-gold-500/20 z-40 shadow-lg pt-16">
        <div class="p-6 h-full flex flex-col">
            <nav class="space-y-2 flex-1">
                <a href="admin_dashboard.html" class="flex items-center px-4 py-3 text-zinc-300 hover:bg-gold-500/10 hover:text-gold-400 rounded-lg transition">
                    <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                </a>
                <a href="admin_registration.html" class="flex items-center px-4 py-3 text-zinc-300 hover:bg-gold-500/10 hover:text-gold-400 rounded-lg transition">
                    <i class="fas fa-user-plus mr-3"></i> Registrations
                </a>
                <a href="admin_students.html" class="flex items-center px-4 py-3 text-zinc-300 hover:bg-gold-500/10 hover:text-gold-400 rounded-lg transition">
                    <i class="fas fa-users mr-3"></i> Students
                </a>
                <a href="admin_instruments.html" class="flex items-center px-4 py-3 text-zinc-300 hover:bg-gold-500/10 hover:text-gold-400 rounded-lg transition">
                    <i class="fas fa-guitar mr-3"></i> Instruments
                </a>
                <a href="admin_sessions.html" class="flex items-center px-4 py-3 text-zinc-300 hover:bg-gold-500/10 hover:text-gold-400 rounded-lg transition">
                    <i class="fas fa-calendar-alt mr-3"></i> Sessions
                </a>
                <a href="admin_package.html" class="flex items-center px-4 py-3 text-gold-400 bg-gold-500/10 rounded-lg">
                    <i class="fas fa-box mr-3"></i> Packages
                </a>
            </nav>
            <div class="border-t border-gold-500/20 pt-6">
                <button onclick="logout()" class="w-full flex items-center px-4 py-3 text-red-400 hover:bg-red-500/10 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 pt-24 p-8">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Student Packages</h2>
                <p class="text-gray-600 dark:text-zinc-400">Assign session packages to active students</p>
            </div>
        </div>

        <!-- Messages -->
        <div id="message" class="hidden mb-4 p-3 rounded text-sm"></div>

        <!-- Filters -->
        <div class="mb-6">
            <div class="bg-white dark:bg-black/50 border border-gray-200 dark:border-gold-500/20 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-zinc-300 mb-2">
                    <i class="fas fa-filter mr-2 text-gold-500"></i>Filter by Branch
                </label>
                <select id="branchFilter" class="w-full md:w-64 px-4 py-2 bg-white dark:bg-zinc-900 border border-gray-300 dark:border-gold-500/20 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold-500 dark:focus:border-gold-400">
                    <option value="">All Branches</option>
                </select>
            </div>
        </div>

        <!-- Students Table -->
        <div class="bg-white dark:bg-black/50 border border-gray-200 dark:border-gold-500/20 rounded-lg overflow-hidden shadow-sm">
            <div class="p-6 border-b border-gray-200 dark:border-gold-500/20 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Active Students</h3>
                <span class="text-xs text-gray-500 dark:text-zinc-400" id="studentCount">Loading...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-black/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Branch</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Current Package</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Sessions</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-zinc-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable" class="divide-y divide-gray-200 dark:divide-gold-500/10">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-zinc-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading students...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Assign Package Modal -->
    <div id="assignPackageModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-black/90 border border-gold-500/30 rounded-lg shadow-2xl w-full max-w-md p-8 relative">
            <button id="closeAssignPackageModalBtn" class="absolute top-4 right-4 text-zinc-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>

            <h3 class="text-2xl font-bold text-white mb-2">Assign Session Package</h3>
            <p class="text-zinc-400 text-xs mb-4" id="assignPackageStudentInfo">Select a session package for this student</p>

            <div id="assignPackageMessage" class="hidden mb-4 p-3 rounded text-sm"></div>

            <form id="assignPackageForm" class="space-y-4">
                <input type="hidden" id="assignStudentId" value="">
                <div>
                    <label class="block text-sm font-medium text-zinc-300 mb-1">Session Package *</label>
                    <select id="assignPackageSelect" required
                        class="w-full px-4 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:outline-none focus:border-gold-400">
                        <option value="">Select Package</option>
                    </select>
                    <p class="text-xs text-zinc-500 mt-1">12 sessions = 1 instrument, 20 sessions = 2 instruments</p>
                    <div id="assignPackagePriceSummary" class="hidden mt-3 bg-zinc-900/50 border border-gold-500/30 rounded-lg p-3">
                        <div class="flex justify-between text-sm text-zinc-300">
                            <span>Package price:</span>
                            <span id="assignPackagePriceDisplay" class="font-semibold text-gold-400">₱0.00</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 pt-4">
                    <button type="button" id="cancelAssignPackageBtn"
                        class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-sm font-semibold rounded-lg transition">
                        Cancel
                    </button>
                    <button type="submit" id="submitAssignPackageBtn"
                        class="inline-flex items-center px-6 py-2 bg-gold-500 hover:bg-gold-400 text-black text-sm font-semibold rounded-lg shadow transition">
                        <span id="submitAssignPackageBtnText">Assign Package</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../js/mode.js"></script>
    <script src="../../js/index.js"></script>
    <script>
        let allStudents = [];
        let packagePagePackages = [];

        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('message');
            if (!messageDiv) return;
            messageDiv.className = `mb-4 p-3 rounded text-sm ${
                type === 'error' ? 'bg-red-900/50 border border-red-500 text-red-200' :
                'bg-green-900/50 border border-green-500 text-green-200'
            }`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            setTimeout(() => messageDiv.classList.add('hidden'), 5000);
        }

        function showAssignPackageMessage(msg, type) {
            const el = document.getElementById('assignPackageMessage');
            if (!el) return;
            el.className = `mb-4 p-3 rounded text-sm ${type === 'error' ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}`;
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        async function loadBranches() {
            const branchFilter = document.getElementById('branchFilter');
            if (!branchFilter) return;

            try {
                const response = await fetch(`${baseApiUrl}/branch.php?action=get-branches`);
                const data = await response.json();

                if (data.success && data.branches) {
                    const options = data.branches.map(branch => 
                        `<option value="${branch.branch_id}">${branch.branch_name}</option>`
                    ).join('');
                    branchFilter.innerHTML = '<option value="">All Branches</option>' + options;
                }
            } catch (error) {
                console.error('Failed to load branches:', error);
            }
        }

        async function loadSessionPackages() {
            try {
                const response = await fetch(`${baseApiUrl}/sessions.php?action=get-packages`);
                const data = await response.json();
                
                if (data.success && data.packages) {
                    packagePagePackages = data.packages;
                    const select = document.getElementById('assignPackageSelect');
                    if (select) {
                        select.innerHTML = '<option value="">Select Package</option>';
                        const formatPrice = (n) => (n != null && !isNaN(n)) ? `₱${Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '₱0.00';
                        data.packages.forEach(pkg => {
                            const option = document.createElement('option');
                            option.value = pkg.package_id;
                            const priceStr = formatPrice(pkg.price);
                            option.textContent = `${pkg.package_name} (${pkg.sessions} sessions, ${pkg.max_instruments} instrument${pkg.max_instruments > 1 ? 's' : ''}) — ${priceStr}`;
                            option.setAttribute('data-price', pkg.price != null ? pkg.price : '0');
                            select.appendChild(option);
                        });
                        select.addEventListener('change', updateAssignPackagePriceDisplay);
                    }
                }
            } catch (error) {
                console.error('Failed to load session packages:', error);
            }
        }

        async function loadActiveStudents() {
            const tableBody = document.getElementById('studentsTable');
            const countEl = document.getElementById('studentCount');
            if (!tableBody) return;

            try {
                const branchFilter = document.getElementById('branchFilter');
                let url = `${baseApiUrl}/students.php?action=get-active-students`;
                if (branchFilter && branchFilter.value) {
                    url += `&branch_id=${branchFilter.value}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.students) {
                    allStudents = data.students;
                    renderStudents(tableBody);
                    if (countEl) countEl.textContent = `${data.students.length} student(s)`;
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-zinc-400">
                                <i class="fas fa-users text-3xl mb-2 text-gold-500/50"></i>
                                <p>No active students found.</p>
                            </td>
                        </tr>`;
                    if (countEl) countEl.textContent = '0 students';
                }
            } catch (error) {
                console.error('Failed to load students:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p>Failed to load students. Please try again.</p>
                        </td>
                    </tr>`;
            }
        }

        function renderStudents(tableBody) {
            if (!allStudents.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-zinc-400">
                            <i class="fas fa-users text-3xl mb-2 text-gold-500/50"></i>
                            <p>No active students found.</p>
                        </td>
                    </tr>`;
                return;
            }

            tableBody.innerHTML = allStudents.map(student => {
                const packageName = student.package_name || 'Not Assigned';
                const sessions = student.sessions || '—';
                const statusBadge = student.registration_status === 'Fee Paid' 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500/20 text-green-600 dark:text-green-400">Fee Paid</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-500/20 text-yellow-600 dark:text-yellow-400">Pending</span>';

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-black/30 transition">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900 dark:text-white">${escapeHtml(student.first_name)} ${escapeHtml(student.last_name)}</div>
                            <div class="text-sm text-gray-500 dark:text-zinc-400">${escapeHtml(student.email || '')}</div>
                        </td>
                        <td class="px-6 py-4 text-gray-700 dark:text-zinc-300">${escapeHtml(student.branch_name || '—')}</td>
                        <td class="px-6 py-4">
                            <span class="text-sm ${student.package_name ? 'text-gold-500 font-medium' : 'text-zinc-500'}">${escapeHtml(packageName)}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-700 dark:text-zinc-300">${sessions}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">
                            <button onclick="openAssignPackageModal(${student.student_id}, '${escapeHtml(student.first_name)} ${escapeHtml(student.last_name)}', ${student.session_package_id || 'null'})" 
                                class="text-gold-500 hover:text-gold-400" title="Assign/Update Package">
                                <i class="fas fa-box"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateAssignPackagePriceDisplay() {
            const select = document.getElementById('assignPackageSelect');
            const summary = document.getElementById('assignPackagePriceSummary');
            const display = document.getElementById('assignPackagePriceDisplay');
            if (!select || !summary || !display) return;
            const opt = select.options[select.selectedIndex];
            const price = opt && opt.value ? parseFloat(opt.getAttribute('data-price') || '0') : 0;
            const formatted = `₱${price.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            display.textContent = formatted;
            summary.classList.toggle('hidden', !opt || !opt.value);
        }

        function openAssignPackageModal(studentId, studentName, currentPackageId) {
            const modal = document.getElementById('assignPackageModal');
            const studentInfo = document.getElementById('assignPackageStudentInfo');
            const studentIdInput = document.getElementById('assignStudentId');
            const packageSelect = document.getElementById('assignPackageSelect');

            if (modal && studentInfo && studentIdInput && packageSelect) {
                studentInfo.textContent = `Select a session package for ${studentName}`;
                studentIdInput.value = studentId;
                packageSelect.value = currentPackageId || '';
                document.getElementById('assignPackageMessage').classList.add('hidden');
                updateAssignPackagePriceDisplay();
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeAssignPackageModal() {
            const modal = document.getElementById('assignPackageModal');
            const msg = document.getElementById('assignPackageMessage');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            if (msg) msg.classList.add('hidden');
        }

        async function assignPackage(e) {
            e.preventDefault();
            const studentId = document.getElementById('assignStudentId').value;
            const packageId = document.getElementById('assignPackageSelect').value;

            if (!studentId || !packageId) {
                showAssignPackageMessage('Please select a package.', 'error');
                return;
            }

            try {
                const response = await fetch(`${baseApiUrl}/students.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'assign-package',
                        student_id: parseInt(studentId),
                        session_package_id: parseInt(packageId)
                    })
                });
                const data = await response.json();

                if (data.success) {
                    closeAssignPackageModal();
                    showMessage('Package assigned successfully.', 'success');
                    loadActiveStudents();
                } else {
                    showAssignPackageMessage(data.error || 'Failed to assign package.', 'error');
                }
            } catch (error) {
                console.error('Failed to assign package:', error);
                showAssignPackageMessage('Network error. Please try again.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Auth !== 'undefined' && Auth.getUser) {
                const user = Auth.getUser();
                if (user) {
                    const userNameNav = document.getElementById('userNameNav');
                    const userRoleNav = document.getElementById('userRoleNav');
                    if (userNameNav) userNameNav.textContent = user.username || user.email || 'Admin';
                    if (userRoleNav) userRoleNav.textContent = user.role_name || 'Admin';
                }
            }

            loadBranches();
            loadSessionPackages();
            loadActiveStudents();

            document.getElementById('branchFilter')?.addEventListener('change', loadActiveStudents);
            document.getElementById('closeAssignPackageModalBtn')?.addEventListener('click', closeAssignPackageModal);
            document.getElementById('cancelAssignPackageBtn')?.addEventListener('click', closeAssignPackageModal);
            document.getElementById('assignPackageForm')?.addEventListener('submit', assignPackage);
        });
    </script>
</body>
</html>
